<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Furrlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="app/jqm/jquery.mobile-1.4.5.css">
    <link rel="stylesheet" href="app/jqm/temas.min.css">
    <link rel="stylesheet" href="app/estilo.css">
    <script src="app/jqm/jquery-1.12.3.min.js"></script>
    <script src="app/jqm/jquery.mobile-1.4.5.js"></script>
</head>

<body>
    <div data-role="page" id="login">
        <div data-role="header">
            <h1>Login</h1>
            <a href="#menu-login" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="panel">☰</a>
        </div>
        <div role="main" class="ui-content">
            <img src="app/img/logo_app.png" alt="foto" style="width:125px; display:block; margin:auto; margin-top: 20px;">
            <h1 style="text-align: center; font-size: 48px; margin-top: 20px;">Furrlist</h1>
            <form id="loginForm" method="post">
                <input type="text" id="t-username" required placeholder="Username">
                <input type="password" id="t-password" required placeholder="Password">
                <input type="submit" value="Login">
            </form>
            <p>¿No tienes una cuenta? <a href="#registerPage">Regístrate</a></p>
        </div>
        <div id="menu-login" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#login" data-transition="slide">Inicio de sesión</a></li>
                <li><a href="#sobre-mi-login" data-transition="slide">Sobre Mi</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="sobre-mi-login">
        <div data-role="header">
            <h1>Sobre Mi</h1>
            <a href="#menu-sobre-mi-login" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
        </div>
        <div role="main" class="ui-content" style="text-align: center">
            <h2>Ludmila Hernaez</h2>
            <h3>Desarrollo de Apps Multiplataforma</h3>
            <p>Diseño Multimedial - Turno Tarde - 5° A</p>
            <p>App de muestra con fines académicos.</p>
            <div class="sobre-mi-login">
                <img src="app/img/ludmila.jpg" alt="Ludmila Hernaez" class="img-fluid">
            </div>
        </div>
        <div id="menu-sobre-mi-login" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#login" data-transition="slide">Inicio de sesión</a></li>
                <li><a href="#sobre-mi-login" data-transition="slide">Sobre Mi</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="registerPage">
        <div data-role="header">
            <h1>Registro</h1>
        </div>
        <div role="main" class="ui-content">
            <img src="app/img/logo_app.png" alt="foto" style="width:125px; display:block; margin:auto; margin-top: 20px;">
            <h1 style="text-align: center; font-size: 48px; margin-top: 20px;">Furrlist</h1>
            <form id="registerForm" method="post" action="php/registro_usuario.php">
                <input type="text" id="username" name="username" required placeholder="Usuario">
                <input type="password" id="password" name="password" required placeholder="Contraseña">
                <input type="submit" value="Registrarse">
            </form>
            <p>¿Ya tienes una cuenta? <a href="#login">Inicia sesión</a></p>
        </div>
    </div>

    <!-- desde aqui es lo de luli -->
    <div data-role="page" id="home">
        <div data-role="header">
            <a href="#submenu" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Mis libros</h1>
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <div style="text-align: center;">
                        <a href="#" id="a" data-icon="heart"><img src="app/img/boton-luna.png" id="a" alt="Van"></a>

                    </div>
                </div>
                <div class="ui-block-b">
                    <div style="text-align: center;">
                        <a href="#" id="b" data-icon="star"><img src="app/img/boton-sol.png" id="b" alt="Van"></a>

                    </div>
                </div>
            </div>
        </div>

        <div role="main" class="ui-content">

            <div id="libros">
            </div>

        </div>

        <div id="submenu" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus" data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="info">
        <div data-role="header">
            <a href="#sub" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Integrantes</h1>
        </div>
        <div role="main" class="ui-content" style="text-align: center">
            <h2>Ludmila Hernaez</h2>
            <h3>Desarrollo de Apps Multiplataforma</h3>
            <p>Diseño Multimedial - Turno Tarde - 5° A</p>
            <p>App de muestra con fines académicos.</p>
            <div class="Sobre Mi">
                <img src="app/img/ludmila.jpg" alt="Ludmila Hernaez" class="img-fluid">
            </div>
        </div>
        <div id="sub" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus" data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="agregar">
        <div data-role="header">
            <a href="#menu" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Agregar libro</h1>
        </div>

        <div role="main" class="ui-content">
            <div class="book-icon">
                <i class="fas fa-book"></i>
            </div>
            <form id="agregarForm" method="post" action="php/save_book.php">
                <input type="text" id="titulo" name="titulo" required placeholder="Título">
                <input type="text" id="autor" name="autor" required placeholder="Autor">
                <input type="text" id="sinopsis" name="sinopsis" required placeholder="Sinopsis">
                <div style="text-align: center;">
                    <a href="#" data-role="button" data-inline="true" data-rel="back">cancelar</a>
                    <input type="submit" value="guardar" data-inline="true">
                </div>
            </form>
        </div>
        <div id="menu" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus"
                        data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="modificar">
        <div data-role="header">
            <h1>Modificar libro</h1>
        </div>

        <div role="main" class="ui-content">
            <form id="modificarForm" method="post" action="php/update_book.php">
                <input type="hidden" id="id_libro" name="id_libro">
                <input type="text" id="modifica_titulo" name="titulo" required placeholder="Título">
                <input type="text" id="modifica_autor" name="autor" required placeholder="Autor">
                <input type="text" id="modifica_sinopsis" name="sinopsis" required placeholder="Sinopsis">
                <div style="text-align: center;">
                    <a href="#" data-role="button" data-inline="true" data-rel="back">Cancelar</a>
                    <input type="submit" value="Guardar" data-inline="true">
                </div>
            </form>
        </div>
    </div>

<!-- scripts -->
<script>
    $(document).ready(function () {
        // Hacer la petición AJAX al archivo PHP para verificar la sesión
        $.ajax({
            url: 'php/check_session.php',
            type: 'GET',
            dataType: 'json', // Especificar el tipo de datos esperado
            success: function (response) {
                // Verificar el estado de la sesión
                if (response.status === "logged_in") {
                    // Si la sesión está iniciada, redirigir a la página principal con la sesión iniciada
                    window.location.href = "index.html#home";
                } else {
                    // Si la sesión no está iniciada, redirigir a la página de inic                              
                    window.location.href = "index.html#login";
                }
            },
            error: function () {
                console.log('Error al verificar la sesión');
            }
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Hacer la petición AJAX al archivo PHP
        $.ajax({
            url: 'php/check_session.php',
            type: 'GET',
            success: function (response) {
                // Imprimir el resultado en la consola
                console.log(response);
            },
            error: function () {
                console.log('Error al comprobar la sesión');
            }
        });
    });

        // Manejar el evento de envío del formulario de login
        $('#loginForm').submit(function (e) {
            // Prevenir el envío del formulario por defecto
            e.preventDefault();

        // Obtener los valores del formulario
        var username = $('#t-username').val();
        var password = $('#t-password').val();

        // Hacer la petición AJAX al archivo PHP para verificar los datos de login
        $.ajax({
            url: 'php/login.php',
            type: 'POST',
            data: { username: username, password: password },
            success: function (response) {
                // Verificar la respuesta del servidor
                if (response === "success") {
                    // Si los datos de login son correctos, mostrar alerta de usuario logeado correctamente
                    alert("Usuario logeado correctamente");
                    // Redirigir a la página principal con la sesión iniciada
                    window.location.href = "index.html#home";
                } else {
                    // Si los datos de login son incorrectos, mostrar alerta de datos inválidos
                    alert("Datos inválidos");
                }
            },
            error: function () {
                console.log('Error al intentar iniciar sesión');
            }
        });
    });

        $(document).ready(function () {
            // Manejar el evento de envío del formulario
            $('#registerForm').submit(function (e) {
                // Prevenir el envío del formulario por defecto
                e.preventDefault();

            // Hacer la petición AJAX al archivo PHP
            $.ajax({
                url: 'php/registro_usuario.php',
                type: 'POST',
                data: $(this).serialize(), // Serializar el formulario
                success: function (response) {
                    // Mostrar una alerta con el mensaje recibido
                    alert(response);

                    // Redirigir a la página principal si el registro fue exitoso
                    if (response === "¡Registro exitoso!") {
                        window.location.href = "index.html#home";
                    }
                },
                error: function () {
                    console.log('Error al registrar el usuario');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Manejar el evento de envío del formulario de agregar libro
        $('#agregarForm').submit(function (e) {
            // Prevenir el envío del formulario por defecto
            e.preventDefault();

            // Crear un objeto FormData para enviar los datos del formulario, incluida la imagen
            var formData = new FormData(this);

            // Hacer la petición AJAX al archivo PHP para agregar el libro
            $.ajax({
                url: 'php/save_book.php',
                type: 'POST',
                data: formData,
                processData: false, // Indicar a jQuery que no procese los datos
                contentType: false, // Indicar a jQuery que no configure el tipo de contenido
                success: function (response) {
                    // Mostrar una alerta con el mensaje recibido
                    if (response === "success") {
                        alert("Libro creado exitosamente");
                        // Redireccionar a index.html#home
                        window.location.href = 'index.html#home';
                        // Limpiar los campos del formulario
                        $('#titulo').val('');
                        $('#autor').val('');
                        $('#sinopsis').val('');
                        $('#portada').val('');
                    } else {
                        alert("Error: " + response); // Mostrar el mensaje de error recibido del servidor
                    }
                },
                error: function () {
                    console.log('Error al agregar el libro');
                }
            });
        });
    });
                </script>
<script>
    $(document).ready(function () {
        // Evento que se dispara antes de mostrar la página #home
        $(document).on("pagecontainerbeforeshow", function (event, ui) {
            var pagina = ui.toPage[0].id;
            if (pagina === "home") {
                cargarLibrosDesdeServidor(); // Llama a la función para cargar los libros desde el servidor
            }
        });

        // Función para cargar libros desde el servidor
        function cargarLibrosDesdeServidor() {
            $.ajax({
                type: "GET",
                url: "php/get_books.php", // Ruta al script PHP que obtiene los libros de la base de datos
                dataType: "json",
                data: { username: localStorage.getItem("loggedUser") }, // Envía el nombre de usuario del usuario actual al servidor
                success: function (response) {
                    // Manejar la respuesta del servidor y mostrar los libros en la página
                    if (response && response.length > 0) {
                        // Limpiar libros existentes
                        $('#libros').empty();
                        // Agregar libros al DOM
                        response.forEach(function (libro) {
                            var libroHTML = '';
                            if (libro.titulo && libro.autor && libro.sinopsis && libro.username && libro.id_libro) {
                                libroHTML = '<div class="libro" data-id="' + libro.id_libro + '">' +
                                    '<div class="contenido">' + // Div para el contenido del libro
                                    '<h3>' + libro.titulo + '</h3>' +
                                    '<h4>' + libro.autor + '</h4>' +
                                    '<p>' + libro.sinopsis + '</p>' +
                                    '</div>' + // Cierre de contenido
                                    '<div class="acciones">' +
                                    '<a href="#" class="edit"><img src="app/jqm/images/icons-png/edit-white.png" alt="editar"></a>' +
                                    '<a href="#" class="delete"><img src="app/jqm/images/icons-png/delete-white.png" alt="eliminar"></a>' +
                                    '</div>' +
                                    '</div>';


                            }
                            $('#libros').append(libroHTML);
                        });

                    } else {
                        // Manejar el caso de que no haya libros en la base de datos
                        $('#libros').text("No hay libros disponibles para este usuario.");
                    }
                },
                error: function (xhr, status, error) {
                    // Manejar errores de la solicitud AJAX
                    console.error("Error al cargar libros desde el servidor:", error);
                }
            });
        }
    });


    // Agregar evento de clic al botón de eliminar
    $(document).on("click", ".delete", function () {
        // Obtener el ID del libro que se va a eliminar
        var libroID = $(this).closest(".libro").data("id");

        // Confirmar si el usuario realmente desea eliminar el libro
        if (confirm("¿Estás seguro de que quieres eliminar este libro?")) {
            // Realizar la petición AJAX para eliminar el libro
            $.ajax({
                url: 'php/delete_book.php',
                type: 'POST',
                data: { id_libro: libroID }, // Enviar el ID del libro al servidor
                success: function (response) {
                    // Manejar la respuesta del servidor
                    if (response === "success") {
                        // Si el libro se eliminó correctamente, recargar la página
                        location.reload();
                        alert("El libro se eliminó correctamente");
                    } else {
                        alert("Error al eliminar el libro: " + response);
                    }
                },
                error: function () {
                    console.log('Error al eliminar el libro');
                }
            });
        }
    });
                </script>

<script>
    $(document).ready(function () {
        // Manejar el envío del formulario de edición
        $('#modificarForm').submit(function (e) {
            // Prevenir el envío del formulario por defecto
            e.preventDefault();

            // Obtener los datos del formulario
            var idLibro = $('#id_libro').val();
            var titulo = $('#modifica_titulo').val();
            var autor = $('#modifica_autor').val();
            var sinopsis = $('#modifica_sinopsis').val();

            // Hacer la petición AJAX para actualizar el libro
            $.ajax({
                url: 'php/update_book.php',
                type: 'POST',
                data: { id_libro: idLibro, titulo: titulo, autor: autor, sinopsis: sinopsis },
                success: function (response) {
                    // Mostrar una alerta con el mensaje recibido
                    if (response === "success") {
                        alert("El libro se actualizó correctamente");
                        // Redirigir a la página principal después de la actualización
                        window.location.href = 'index.html#home';
                    } else {
                        alert("Error al actualizar el libro: " + response);
                    }
                },
                error: function () {
                    console.log('Error al enviar datos de edición del libro');
                }
            });
        });
    });

        // Definir la función para cargar los detalles del libro en el formulario de edición
        function cargarDetallesLibro(id_libro, titulo, autor, sinopsis) {
            $("#id_libro").val(id_libro);
            $("#modifica_titulo").val(titulo);
            $("#modifica_autor").val(autor);
            $("#modifica_sinopsis").val(sinopsis);
    }

        // Evento de clic para el enlace de edición
        $(document).on("click", ".edit", function () {
            var libroID = $(this).closest(".libro").data("id"); // Obtener el ID del libro
            var titulo = $(this).closest(".libro").find("h3").text(); // Obtener el título del libro
            var autor = $(this).closest(".libro").find("h4").text(); // Obtener el autor del libro
            var sinopsis = $(this).closest(".libro").find("p").text(); // Obtener la sinopsis del libro

        // Llamar a la función para cargar los detalles del libro en el formulario de edición
        cargarDetallesLibro(libroID, titulo, autor, sinopsis);

        // Redirigir al formulario de edición
        $.mobile.navigate("#modificar");
    });
</script>

<script>
    function cerrarSesion() {
        // Hacer la petición AJAX para cerrar la sesión
        $.ajax({
            url: 'php/logout.php',
            type: 'GET',
            success: function (response) {
                // Recargar la página actual después de cerrar sesión
                location.reload();
                // Después del reload, redirigir a la página de inicio de sesión después de 1 segundo
                setTimeout(function () {
                    window.location.href = "index.html#login";
                }, 1000);
            },
            error: function () {
                console.log('Error al cerrar sesión');
            }
        });
                }
            </script>

<script>
    // Event to change theme to "a"
    $('#a').on("click", function () {
        cambiarTema("a");
    });

        // Event to change theme to "b"
        $('#b').on("click", function () {
            cambiarTema("b");
        });

        // Function to change theme
        function cambiarTema(tema) {
            $('#info, .ui-content, main, div[data-role=page]').removeClass("ui-page-theme-a ui-page-theme-b").addClass("ui-page-theme-" + tema);
            localStorage.setItem("tema", tema);
        }

        // Event triggered when document is ready to set saved theme
        $(document).on("ready", function () {
            var tema_guardado = localStorage.getItem("tema");
            if (tema_guardado) {
                $('[data-role=page]').addClass("ui-page-theme-" + tema_guardado);
            }
        });
    </script>


</body>

</html>