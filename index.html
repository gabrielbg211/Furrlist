<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Furrlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="app/jqm/jquery.mobile-1.4.5.css">
    <link rel="stylesheet" href="app/jqm/temas.min.css">
    <link rel="stylesheet" href="app/estilo.css">
    <script src="app/jqm/jquery-1.12.3.min.js"></script>
    <script src="app/jqm/jquery.mobile-1.4.5.js"></script>
</head>

<body>
    <div data-role="page" id="login">
        <div data-role="header">
            <h1>Login</h1>
            <a href="#menu-login" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="panel">☰</a>
        </div>
        <div role="main" class="ui-content">
            <img src="app/img/logo_app.png" alt="foto" style="width:125px; display:block; margin:auto; margin-top: 20px;">
            <h1 style="text-align: center; font-size: 48px; margin-top: 20px;">Furrlist</h1>
            <form id="loginForm" method="post">
                <input type="text" id="t-username" required placeholder="Username">
                <input type="password" id="t-password" required placeholder="Password">
                <input type="submit" value="Login">
            </form>
            <p>¿No tienes una cuenta? <a href="#registerPage">Regístrate</a></p>
        </div>
        <div id="menu-login" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#login" data-transition="slide">Inicio de sesión</a></li>
                <li><a href="#sobre-mi-login" data-transition="slide">Sobre Mi</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="sobre-mi-login">
        <div data-role="header">
            <h1>Sobre Mi</h1>
            <a href="#menu-sobre-mi-login" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
        </div>
        <div role="main" class="ui-content" style="text-align: center">
            <h2>Ludmila Hernaez</h2>
            <h3>Desarrollo de Apps Multiplataforma</h3>
            <p>Diseño Multimedial - Turno Tarde - 5° A</p>
            <p>App de muestra con fines académicos.</p>
            <div class="sobre-mi-login">
                <img src="app/img/ludmila.jpg" alt="Ludmila Hernaez" class="img-fluid">
            </div>
        </div>
        <div id="menu-sobre-mi-login" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#login" data-transition="slide">Inicio de sesión</a></li>
                <li><a href="#sobre-mi-login" data-transition="slide">Sobre Mi</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="registerPage">
        <div data-role="header">
            <h1>Registro</h1>
        </div>
        <div role="main" class="ui-content">
            <img src="app/img/logo_app.png" alt="foto" style="width:125px; display:block; margin:auto; margin-top: 20px;">
            <h1 style="text-align: center; font-size: 48px; margin-top: 20px;">Furrlist</h1>
            <!-- <form id="registerForm" method="post" action="php/registro_usuario.php"> -->
            <form id="registerForm" method="post">
                <input type="text" id="username" name="username" required placeholder="Usuario">
                <input type="password" id="password" name="password" required placeholder="Contraseña">
                <input type="submit" value="Registrarse">
            </form>
            <p>¿Ya tienes una cuenta? <a href="#login">Inicia sesión</a></p>
        </div>
    </div>

    <!-- desde aqui es lo de luli -->
    <div data-role="page" id="home">
        <div data-role="header">
            <a href="#submenu" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Mis libros</h1>
            <div class="ui-grid-a">
                <div class="ui-block-a">
                    <div style="text-align: center;">
                        <a href="#" id="a" data-icon="heart"><img src="app/img/boton-luna.png" id="a" alt="Van"></a>

                    </div>
                </div>
                <div class="ui-block-b">
                    <div style="text-align: center;">
                        <a href="#" id="b" data-icon="star"><img src="app/img/boton-sol.png" id="b" alt="Van"></a>

                    </div>
                </div>
            </div>
        </div>

        <div role="main" class="ui-content">

            <div id="libros">
            </div>

        </div>

        <div id="submenu" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus" data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="info">
        <div data-role="header">
            <a href="#sub" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Integrantes</h1>
        </div>
        <div role="main" class="ui-content" style="text-align: center">
            <h2>Ludmila Hernaez</h2>
            <h3>Desarrollo de Apps Multiplataforma</h3>
            <p>Diseño Multimedial - Turno Tarde - 5° A</p>
            <p>App de muestra con fines académicos.</p>
            <div class="Sobre Mi">
                <img src="app/img/ludmila.jpg" alt="Ludmila Hernaez" class="img-fluid">
            </div>
        </div>
        <div id="sub" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus" data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="agregar">
        <div data-role="header">
            <a href="#menu" data-role="button" data-icon="bars" data-iconpos="notext" class="ui-btn-left"
                data-rel="open">☰</a>
            <h1>Agregar libro</h1>
        </div>

        <div role="main" class="ui-content">
            <div class="book-icon">
                <i class="fas fa-book"></i>
            </div>
            <!-- <form id="agregarForm" method="post" action="php/save_book.php"> -->
            <form id="agregarForm" method="post">
                <input type="text" id="titulo" name="titulo" required placeholder="Título">
                <input type="text" id="autor" name="autor" required placeholder="Autor">
                <input type="text" id="sinopsis" name="sinopsis" required placeholder="Sinopsis">
                <div style="text-align: center;">
                    <a href="#" data-role="button" data-inline="true" data-rel="back">cancelar</a>
                    <input type="submit" value="guardar" data-inline="true">
                </div>
            </form>
        </div>
        <div id="menu" data-role="panel" data-display="push">
            <div style="margin-bottom:40px;">
                <img src="app/img/logo_app.png" alt="foto" style="width:200px;" />
            </div>
            <ul data-role="listview">
                <li><a href="#home" data-role="button" data-transition="slide" data-icon="home">Inicio</a></li>
                <li><a href="#agregar" data-role="button" data-transition="slide" data-icon="plus"
                        data-iconpos="left">Agregar libro</a>
                </li>
                <li><a href="#info" data-role="button" data-transition="slide" data-icon="info">Sobre Mi</a></li>
                <li><a href="#" data-role="button" data-icon="power" onclick="cerrarSesion()">Cerrar Sesión</a></li>
            </ul>
        </div>
    </div>

    <div data-role="page" id="modificar">
        <div data-role="header">
            <h1>Modificar libro</h1>
        </div>

        <div role="main" class="ui-content">
            <!-- <form id="modificarForm" method="post" action="php/update_book.php"> -->
            <form id="modificarForm" method="post" action="php/update_book.php">
                <input type="hidden" id="id_libro" name="id_libro">
                <input type="text" id="modifica_titulo" name="titulo" required placeholder="Título">
                <input type="text" id="modifica_autor" name="autor" required placeholder="Autor">
                <input type="text" id="modifica_sinopsis" name="sinopsis" required placeholder="Sinopsis">
                <div style="text-align: center;">
                    <a href="#" data-role="button" data-inline="true" data-rel="back">Cancelar</a>
                    <input type="submit" value="Guardar" data-inline="true">
                </div>
            </form>
        </div>
    </div>

    <!-- localstorage -->
    
    <script>
        $(document).ready(function () {
            // Verificar si hay una sesión activa con AJAX
            $.ajax({
                url: 'php/check_session.php',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    console.log(response);
                    if (response.status === "logged_in") {
                        // Si hay una sesión activa, redirigir a la página de inicio
                        window.location.href = "index.html#home";
                    } else {
                        // Si no hay sesión activa, verificar la página y redirigir según sea necesario
                        verificarPagina();
                    }
                },
                error: function () {
                    console.log('Error al verificar la sesión');
                    // En caso de error, también verificar la página y redirigir según sea necesario
                    verificarPagina();
                }
            });

            // Función para verificar la página y redirigir según sea necesario
            function verificarPagina() {
                // Verificar si la página es index.html#home y hay una sesión activa
                if (window.location.hash === '#home') {
                    var currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (!currentUser) {
                        // Si no hay sesión activa, redirigir al inicio de sesión
                        window.location.href = 'index.html#login';
                    }
                }

                // Verificar si la página es index.html#login o index.html#registerPage y hay una sesión activa
                if (window.location.hash === '#login' || window.location.hash === '#registerPage') {
                    var currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (currentUser) {
                        // Si hay sesión activa, redirigir a la página de inicio
                        window.location.href = 'index.html#home';
                    }
                }

                // Llamar a verificarSesion una vez para mostrar el estado de la sesión actual
                verificarSesion();
            }

            // Función para verificar la sesión almacenada localmente
            function verificarSesion() {
                var currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    // Hay una sesión activa
                    console.log('Sesión con localStorage:', currentUser.username);
                } else {
                    // No hay sesión activa
                    console.log('No hay sesión activa con localStorage');
                }
            }
        });
    </script>
    
    
    <script>
        $(document).ready(function () {
            // Función para registrar el usuario utilizando AJAX
            function registrarUsuarioAJAX(formData) {
                $.ajax({
                    url: 'php/registro_usuario.php',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        alert(response);
                        if (response === "¡Registro exitoso!") {
                            window.location.href = "index.html#home";
                            location.reload();
                        }
                    },
                    error: function () {
                        console.log('Error al registrar el usuario');
                    }
                });
            }

            // Función para registrar el usuario en el localStorage e iniciar sesión
            function registrarUsuarioLocalStorage(username, password) {
                // Verificar si el usuario ya existe en el localStorage
                var users = JSON.parse(localStorage.getItem('users')) || [];
                var userExists = users.some(function (user) {
                    return user.username === username;
                });

                if (userExists) {
                    alert('El usuario ya existe');
                    return;
                }

                // Crear un nuevo usuario
                var newUser = {
                    username: username,
                    password: password
                };

                // Guardar el nuevo usuario en el localStorage
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));

                // Iniciar sesión automáticamente en el localStorage
                localStorage.setItem('currentUser', JSON.stringify(newUser));

                alert('Usuario registrado correctamente');

                // Limpiar el formulario
                $('#username').val('');
                $('#password').val('');
            }


            // Manejar el evento de submit del formulario de registro
            $('#registerForm').submit(function (e) {
                e.preventDefault();
                var username = $('#username').val();
                var password = $('#password').val();

                // Registrar el usuario utilizando AJAX
                registrarUsuarioAJAX($(this).serialize());

                // Registrar el usuario en el localStorage
                registrarUsuarioLocalStorage(username, password);
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            // Función para iniciar sesión utilizando AJAX
            function iniciarSesionAJAX(username, password) {
                $.ajax({
                    url: 'php/login.php',
                    type: 'POST',
                    data: { username: username, password: password },
                    success: function (response) {
                        if (response === "success") {
                            alert("Usuario logeado correctamente");
                            window.location.href = "index.html#home";
                            location.reload();
                        } else {
                            alert("Datos inválidos");
                        }
                    },
                    error: function () {
                        console.log('Error al intentar iniciar sesión');
                    }
                });
            }

            // Función para iniciar sesión utilizando el localStorage
            function iniciarSesionLocalStorage(username, password) {
                // Obtener la lista de usuarios del localStorage
                var users = JSON.parse(localStorage.getItem('users')) || [];

                // Buscar el usuario en la lista
                var user = users.find(function (user) {
                    return user.username === username && user.password === password;
                });

                if (user) {
                    // Usuario autenticado correctamente
                    alert('Inicio de sesión exitoso');
                    // Guardar el usuario actual en el localStorage
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    // Mostrar el mensaje de sesión activa en consola
                    console.log('Sesión con localStorage:', user.username);
                    // Redirigir a la página principal después del inicio de sesión
                    window.location.href = 'index.html#home';
                    location.reload();
                } else {
                    // Credenciales incorrectas
                    alert('Credenciales incorrectas. Por favor, intenta de nuevo.');
                }
            }

            // Manejar el evento de submit del formulario de inicio de sesión
            $('#loginForm').submit(function (e) {
                e.preventDefault();
                var username = $('#t-username').val();
                var password = $('#t-password').val();

                // Iniciar sesión utilizando AJAX
                iniciarSesionAJAX(username, password);

                // Iniciar sesión utilizando el localStorage
                iniciarSesionLocalStorage(username, password);
            });
        });

    </script>
    
    <script>
        // Función para cerrar la sesión utilizando AJAX
        function cerrarSesionAJAX() {
            $.ajax({
                url: 'php/logout.php',
                type: 'GET',
                success: function (response) {
                    location.reload();
                    setTimeout(function () {
                        window.location.href = "index.html#login";
                    }, 1000);
                },
                error: function () {
                    console.log('Error al cerrar sesión');
                }
            });
        }

        // Función para cerrar la sesión utilizando el localStorage
        function cerrarSesionLocalStorage() {
            // Limpiar el usuario actual del localStorage
            localStorage.removeItem('currentUser');
            // Redirigir a la página de inicio de sesión
            window.location.href = 'index.html#login';
            // Recargar la página
            location.reload();
        }

        // Función para cerrar la sesión, llamando a ambas funciones secuencialmente
        function cerrarSesion() {
            cerrarSesionAJAX();
            cerrarSesionLocalStorage();
        }

    </script>
    
    
    <script>
        $(document).ready(function () {
            // Delegación de eventos para el botón editar
            $('#libros').on('click', '.libro .edit', function () {
                var titulo_actual = $(this).parent().find("h3").text();
                var autor_actual = $(this).parent().find("h4").text();
                var sinopsis_actual = $(this).parent().find("p").text();
                var id_libro = $(this).closest('.libro').attr('id'); // Obtener el ID del libro

                console.log("Datos del libro seleccionado:");
                console.log("ID del libro:", id_libro);
                console.log("Título:", titulo_actual);
                console.log("Autor:", autor_actual);
                console.log("Sinopsis:", sinopsis_actual);

                $('#modifica_titulo').val(titulo_actual);
                $('#modifica_autor').val(autor_actual);
                $('#modifica_sinopsis').val(sinopsis_actual);
                $('#modificar').attr('data-id', id_libro); // Agregar el ID del libro al formulario de modificación
                $(this).parent().attr("data-modificando", "este");
                $.mobile.navigate('#modificar');
            });




            // Delegación de eventos para el botón eliminar
            $('#libros').on('click', '.libro .delete', function () {
                var eliminar_libro = confirm("¿Estás seguro que quieres eliminar el libro?");
                if (eliminar_libro) {
                    $(this).closest('.libro').remove(); // Utiliza closest para encontrar el contenedor del libro
                    // Guardar los libros actualizados en el almacenamiento local
                    guardarLibros();
                }
            });

            $(document).ready(function () {
                $('#agregarForm').submit(function (e) {
                    e.preventDefault();
                    var formData = new FormData(this);
                    $.ajax({
                        url: 'php/save_book.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if (response === "success") {
                                alert("Libro creado exitosamente");

                                // Guardar en el localStorage
                                guardarEnLocalStorage();

                                // Redirigir a la página de inicio
                                location.reload();
                                window.location.href = 'index.html#home';
                            } else {
                                alert("Error: " + response);
                            }
                        },
                        error: function () {
                            console.log('Error al agregar el libro');
                        }
                    });
                });

                // Función para guardar el libro en el localStorage
                function guardarEnLocalStorage() {
                    var titulo = $('#titulo').val();
                    var autor = $('#autor').val();
                    var sinopsis = $('#sinopsis').val();

                    // Obtener el usuario actual del almacenamiento local
                    var currentUser = JSON.parse(localStorage.getItem('currentUser'));

                    if (!currentUser) {
                        console.error('No se ha iniciado sesión');
                        return false; // Salir de la función si no hay usuario actual
                    }

                    // Generar un id_libro único usando el timestamp actual en milisegundos
                    var id_libro = 'libro_' + Date.now();

                    // Crear un objeto de libro con la información necesaria
                    var nuevoLibro = {
                        id_libro: id_libro,
                        titulo: titulo,
                        autor: autor,
                        sinopsis: sinopsis,
                        usuario: currentUser.username
                    };

                    // Obtener los libros actuales del almacenamiento local
                    var librosActuales = JSON.parse(localStorage.getItem("libros")) || [];

                    // Agregar el nuevo libro a la lista de libros actuales
                    librosActuales.push(nuevoLibro);

                    // Guardar los libros actualizados en el almacenamiento local
                    localStorage.setItem("libros", JSON.stringify(librosActuales));

                    // Restablecer los campos del formulario
                    $('#titulo').val('');
                    $('#autor').val('');
                    $('#sinopsis').val('');
                }
            });

            $(document).ready(function () {
                $('#modificarForm').submit(function (e) {
                    e.preventDefault();
                    var idLibro = $('#id_libro').val();
                    var titulo = $('#modifica_titulo').val();
                    var autor = $('#modifica_autor').val();
                    var sinopsis = $('#modifica_sinopsis').val();
                    $.ajax({
                        url: 'php/update_book.php',
                        type: 'POST',
                        data: { id_libro: idLibro, titulo: titulo, autor: autor, sinopsis: sinopsis },
                        success: function (response) {
                            if (response === "success") {
                                alert("El libro se actualizó correctamente");
                                window.location.href = 'index.html#home';
                                location.reload();
                            } else {
                                alert("Error al actualizar el libro: " + response);
                            }
                        },
                        error: function () {
                            console.log('Error al enviar datos de edición del libro');
                        }
                    });
                });
            });

            function cargarDetallesLibro(id_libro, titulo, autor, sinopsis) {
                $("#id_libro").val(id_libro);
                $("#modifica_titulo").val(titulo);
                $("#modifica_autor").val(autor);
                $("#modifica_sinopsis").val(sinopsis);
            }

            $(document).on("click", ".edit", function () {
                var libroID = $(this).closest(".libro").data("id");
                var titulo = $(this).closest(".libro").find("h3").text();
                var autor = $(this).closest(".libro").find("h4").text();
                var sinopsis = $(this).closest(".libro").find("p").text();
                cargarDetallesLibro(libroID, titulo, autor, sinopsis);
            });

            // Restablecer los campos del formulario al mostrar la página "agregar"
            $(document).on("pagebeforeshow", "#agregar", function () {
                $('#titulo').val('');
                $('#autor').val('');
                $('#sinopsis').val('');
            });

            $(document).ready(function () {
                // Función para cargar los libros desde el servidor si la base de datos no está disponible
                function cargarLibrosDesdeServidorSiNoDisponible() {
                    $.ajax({
                        type: "GET",
                        url: "php/get_books.php",
                        dataType: "json",
                        data: { username: localStorage.getItem("loggedUser") },
                        success: function (response) {
                            if (response && response.length > 0) {
                                $('#libros').empty();
                                response.forEach(function (libro) {
                                    var libroHTML = '';
                                    if (libro.titulo && libro.autor && libro.sinopsis && libro.username && libro.id_libro) {
                                        libroHTML = '<div class="libro" data-id="' + libro.id_libro + '">' +
                                            '<img src="' + libro.portada + '" alt="Portada del libro" class="portada img-fluid">' +
                                            '<div class="contenido">' +
                                            '<h3>' + libro.titulo + '</h3>' +
                                            '<h4>' + libro.autor + '</h4>' +
                                            '<p>' + libro.sinopsis + '</p>' +
                                            '</div>' +
                                            '<div class="acciones">' +
                                            '<a href="#" class="edit"><img src="app/jqm/images/icons-png/edit-white.png" alt="editar"></a>' +
                                            '<a href="#" class="delete"><img src="app/jqm/images/icons-png/delete-white.png" alt="eliminar"></a>' +
                                            '</div>' +
                                            '</div>';
                                    }
                                    $('#libros').append(libroHTML);
                                });
                            } else {
                                $('#libros').text("No hay libros disponibles para este usuario.");
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error al cargar libros desde el servidor:", error);
                            // Si hay un error al cargar desde el servidor, cargar desde el localStorage
                            cargarLibrosDesdeLocalStorage();
                        }
                    });
                }

                // Función para cargar los libros desde el localStorage
                function cargarLibrosDesdeLocalStorage() {
                    var currentUser = JSON.parse(localStorage.getItem('currentUser'));

                    if (currentUser) {
                        var recuperados_json = localStorage.getItem("libros");

                        if (recuperados_json) {
                            var recuperados_array = JSON.parse(recuperados_json);
                            $.each(recuperados_array, function (indice, libro) {
                                var libroHtml =
                                    '<div class="libro" id="' + libro.id_libro + '">' +
                                    '<img src="app/img/libro-pata.png" class="portada" alt="Portada del libro">' +
                                    '<a href="#" class="edit" data-id="' + libro.id_libro + '"><img src="app/jqm/images/icons-png/edit-white.png" alt="editar"></a>' +
                                    '<a href="#" class="delete"><img src="app/jqm/images/icons-png/delete-white.png" alt="eliminar"></a>' +
                                    '<div class="contenido">' +
                                    '<h3>' + libro.titulo + '</h3>' +
                                    '<h4>' + libro.autor + '</h4>' +
                                    '<p>' + libro.sinopsis + '</p>' +
                                    '</div>' +
                                    '</div>';

                                // Mostrar el libro en la lista de libros si pertenece al usuario actual
                                if (libro.usuario === currentUser.username) {
                                    $('#libros').append(libroHtml);
                                }
                            });
                        }
                    } else {
                        console.error('No se ha iniciado sesión');
                    }
                }

                // Llamar a la función para cargar libros desde el servidor si no está disponible
                cargarLibrosDesdeServidorSiNoDisponible();
            });

            // Evento de clic en el botón de editar un libro
            $(document).on("click", ".edit", function () {
                var libroID = $(this).closest(".libro").data("id");
                var titulo = $(this).closest(".libro").find("h3").text();
                var autor = $(this).closest(".libro").find("h4").text();
                var sinopsis = $(this).closest(".libro").find("p").text();

                console.log("ID del libro:", libroID);
                console.log("Título:", titulo);
                console.log("Autor:", autor);
                console.log("Sinopsis:", sinopsis);

                // Verificar si el libro proviene de la base de datos o del localStorage
                var fuente = $(this).closest(".libro").attr("data-fuente");

                // Cargar los detalles del libro en el formulario de modificación
                cargarDetallesLibro(libroID, titulo, autor, sinopsis, fuente);

                // Navegar a la página de modificación
                $.mobile.navigate("#modificar");
            });

            function cargarDetallesLibro(id_libro, titulo, autor, sinopsis) {
                $("#id_libro").val(id_libro);
                $("#modifica_titulo").val(titulo);
                $("#modifica_autor").val(autor);
                $("#modifica_sinopsis").val(sinopsis);
            }


            // Función para guardar los libros en el almacenamiento local
            function guardarLibros() {
                var libros_actuales = [];

                $('#libros .libro').each(function () {
                    var titulo = $(this).find('h3').text();
                    var autor = $(this).find('h4').text();
                    var sinopsis = $(this).find('p').text();
                    var usuario = $(this).attr('data-usuario');

                    libros_actuales.push({
                        titulo: titulo,
                        autor: autor,
                        sinopsis: sinopsis,
                        usuario: usuario
                    });
                });

                var actuales_json = JSON.stringify(libros_actuales);
                localStorage.setItem("libros", actuales_json);
            }
        });

        $(document).on("click", ".delete", function () {
        var libroID = $(this).closest(".libro").data("id");
        if (confirm("¿Estás seguro de que quieres eliminar este libro?")) {
            $.ajax({
                url: 'php/delete_book.php',
                type: 'POST',
                data: { id_libro: libroID },
                success: function (response) {
                    if (response === "success") {
                        location.reload();
                        alert("El libro se eliminó correctamente");
                    } else {
                        alert("Error al eliminar el libro: " + response);
                    }
                },
                error: function () {
                    console.log('Error al eliminar el libro');
                }
            });
        }
    });
            </script>
            
            
            <!-- scripts Base de datos -->
            <!-- <script>
                                                                                                                                                                                        $(document).ready(function () {
        $.ajax({
            url: 'php/check_session.php',
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                console.log(response);
                if (response.status === "logged_in") {
                    window.location.href = "index.html#home";
                } else {
                    window.location.href = "index.html#login";
                }
            },
            error: function () {
                console.log('Error al verificar la sesión');
            }
        });
    });
</script>
<script>
    $('#loginForm').submit(function (e) {
        e.preventDefault();
        var username = $('#t-username').val();
        var password = $('#t-password').val();
        $.ajax({
            url: 'php/login.php',
            type: 'POST',
            data: { username: username, password: password },
            success: function (response) {
                if (response === "success") {
                    alert("Usuario logeado correctamente");
                    window.location.href = "index.html#home";
                    location.reload();
                } else {
                    alert("Datos inválidos");
                }
            },
            error: function () {
                console.log('Error al intentar iniciar sesión');
            }
        });
    });

    $(document).ready(function () {
        $('#registerForm').submit(function (e) {
            e.preventDefault();
            $.ajax({
                url: 'php/registro_usuario.php',
                type: 'POST',
                data: $(this).serialize(),
                success: function (response) {
                    alert(response);
                    if (response === "¡Registro exitoso!") {
                        window.location.href = "index.html#home";
                        location.reload();
                    }
                },
                error: function () {
                    console.log('Error al registrar el usuario');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#agregarForm').submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: 'php/save_book.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response === "success") {
                        alert("Libro creado exitosamente");
                        window.location.href = 'index.html#home';
                        $('#titulo').val('');
                        $('#autor').val('');
                        $('#sinopsis').val('');
                        $('#portada').val('');
                    } else {
                        alert("Error: " + response);
                    }
                },
                error: function () {
                    console.log('Error al agregar el libro');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $(document).on("pagecontainerbeforeshow", function (event, ui) {
            var pagina = ui.toPage[0].id;
            if (pagina === "home") {
                cargarLibrosDesdeServidor();
            }
        });

        function cargarLibrosDesdeServidor() {
            $.ajax({
                type: "GET",
                url: "php/get_books.php",
                dataType: "json",
                data: { username: localStorage.getItem("loggedUser") },
                success: function (response) {
                    if (response && response.length > 0) {
                        $('#libros').empty();
                        response.forEach(function (libro) {
                            var libroHTML = '';
                            if (libro.titulo && libro.autor && libro.sinopsis && libro.username && libro.id_libro) {
                                libroHTML = '<div class="libro" data-id="' + libro.id_libro + '">' +
                                    '<img src="' + libro.portada + '" alt="Portada del libro" class="portada img-fluid">' +
                                    '<div class="contenido">' +
                                    '<h3>' + libro.titulo + '</h3>' +
                                    '<h4>' + libro.autor + '</h4>' +
                                    '<p>' + libro.sinopsis + '</p>' +
                                    '</div>' +
                                    '<div class="acciones">' +
                                    '<a href="#" class="edit"><img src="app/jqm/images/icons-png/edit-white.png" alt="editar"></a>' +
                                    '<a href="#" class="delete"><img src="app/jqm/images/icons-png/delete-white.png" alt="eliminar"></a>' +
                                    '</div>' +
                                    '</div>';
                            }
                            $('#libros').append(libroHTML);
                        });
                    } else {
                        $('#libros').text("No hay libros disponibles para este usuario.");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error al cargar libros desde el servidor:", error);
                }
            });
        }
    });

    $(document).on("click", ".delete", function () {
        var libroID = $(this).closest(".libro").data("id");
        if (confirm("¿Estás seguro de que quieres eliminar este libro?")) {
            $.ajax({
                url: 'php/delete_book.php',
                type: 'POST',
                data: { id_libro: libroID },
                success: function (response) {
                    if (response === "success") {
                        location.reload();
                        alert("El libro se eliminó correctamente");
                    } else {
                        alert("Error al eliminar el libro: " + response);
                    }
                },
                error: function () {
                    console.log('Error al eliminar el libro');
                }
            });
        }
    });
</script>
<script>
    $(document).ready(function () {
        $('#modificarForm').submit(function (e) {
            e.preventDefault();
            var idLibro = $('#id_libro').val();
            var titulo = $('#modifica_titulo').val();
            var autor = $('#modifica_autor').val();
            var sinopsis = $('#modifica_sinopsis').val();
            $.ajax({
                url: 'php/update_book.php',
                type: 'POST',
                data: { id_libro: idLibro, titulo: titulo, autor: autor, sinopsis: sinopsis },
                success: function (response) {
                    if (response === "success") {
                        alert("El libro se actualizó correctamente");
                        window.location.href = 'index.html#home';
                    } else {
                        alert("Error al actualizar el libro: " + response);
                    }
                },
                error: function () {
                    console.log('Error al enviar datos de edición del libro');
                }
            });
        });
    });

    function cargarDetallesLibro(id_libro, titulo, autor, sinopsis) {
    $("#id_libro").val(id_libro);
    $("#modifica_titulo").val(titulo);
    $("#modifica_autor").val(autor);
    $("#modifica_sinopsis").val(sinopsis);
    }

    $(document).on("click", ".edit", function () {
        var libroID = $(this).closest(".libro").data("id");
        var titulo = $(this).closest(".libro").find("h3").text();
        var autor = $(this).closest(".libro").find("h4").text();
        var sinopsis = $(this).closest(".libro").find("p").text();
        cargarDetallesLibro(libroID, titulo, autor, sinopsis);
        $.mobile.navigate("#modificar");
    });
</script>
<script>
    function cerrarSesion() {
        $.ajax({
            url: 'php/logout.php',
            type: 'GET',
            success: function (response) {
                location.reload();
                setTimeout(function () {
                    window.location.href = "index.html#login";
                }, 1000);
            },
            error: function () {
                console.log('Error al cerrar sesión');
            }
        });
    }
    </script>-->
    <script>
                                                                    $('#a').on("click", function () {
                                                                    $('#info, .ui-content, main, div[data-role=page]').removeClass("ui-page-theme-b")
                                                                        .addClass("ui-page-theme-a");


                                                                    localStorage.setItem("tema", "a");
                                                                });

        $('#b').on("click", function () {
            $('#info, .ui-content, main, div[data-role=page]').removeClass("ui-page-theme-a")
                .addClass("ui-page-theme-b");

            localStorage.setItem("tema", "b");
        });

        $(document).on("ready", function () {
            var tema_guardado = localStorage.getItem("tema");
            if (tema_guardado != null &&
                tema_guardado != undefined &&
                tema_guardado != '') {
                $('[data-role=page]').addClass("ui-page-theme-" + tema_guardado);
            }
        });
    </script>

</body>

</html>